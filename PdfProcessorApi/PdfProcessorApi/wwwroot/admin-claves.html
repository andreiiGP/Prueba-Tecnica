<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Administrar Claves DocKey</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">

    <div class="container mt-5">
        <h2 class="mb-4">Administrar Palabras Clave (DocKey)</h2>

        <!-- Formulario -->
        <form id="claveForm" class="mb-4">
            <input type="hidden" id="docKeyId">
            <div class="row">
                <div class="col-md-4">
                    <input type="text" class="form-control" id="clave" placeholder="Palabra clave" required>
                </div>
                <div class="col-md-4">
                    <input type="text" class="form-control" id="docName" placeholder="Nombre del documento" required>
                </div>
                <div class="col-md-4 d-grid">
                    <button type="submit" class="btn btn-primary">Guardar</button>
                </div>
            </div>
        </form>

        <div id="message"></div>

        <!-- Tabla de claves -->
        <table class="table table-bordered table-striped" id="docKeysTable">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Clave</th>
                    <th>DocName</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
    <a href="index.html">Subir PDF </a>
    <br />
    <a href="logs.html">Ver Registro logs</a>

    <script>
        const apiUrl = 'https://localhost:7029/api/dockey';

        document.addEventListener('DOMContentLoaded', loadDocKeys);
        document.getElementById('claveForm').addEventListener('submit', handleFormSubmit);

        async function loadDocKeys() {
            const res = await fetch(apiUrl);
            const data = await res.json();
            const tbody = document.querySelector('#docKeysTable tbody');
            tbody.innerHTML = '';
            data.forEach(doc => {
                tbody.innerHTML += `
                        <tr>
                            <td>${doc.id}</td>
                            <td>${doc.clave}</td>
                            <td>${doc.docName}</td>
                            <td>
                                <button class="btn btn-sm btn-warning" onclick="editDocKey(${doc.id}, '${doc.clave}', '${doc.docName}')">Editar</button>
                                <button class="btn btn-sm btn-danger" onclick="deleteDocKey(${doc.id})">Eliminar</button>
                            </td>
                        </tr>`;
            });
        }

        function editDocKey(id, clave, docName) {
            document.getElementById('docKeyId').value = id;
            document.getElementById('clave').value = clave;
            document.getElementById('docName').value = docName;
        }

        async function deleteDocKey(id) {
            if (!confirm('¿Estás seguro de eliminar esta clave?')) return;
            await fetch(`${apiUrl}/${id}`, { method: 'DELETE' });
            loadDocKeys();
            showMessage('Clave eliminada', 'success');
        }

        async function handleFormSubmit(e) {
            e.preventDefault();
            const id = document.getElementById('docKeyId').value.trim();
            const clave = document.getElementById('clave').value.trim();
            const docName = document.getElementById('docName').value.trim();

            let body;
            let method;
            let url;

            if (id) {
                // Editar
                body = JSON.stringify({ id: parseInt(id), clave, docName });
                method = 'PUT';
                url = `${apiUrl}/${id}`;
            } else {
                // Insertar
                body = JSON.stringify({ clave, docName }); // sin id
                method = 'POST';
                url = apiUrl;
            }

            try {
                const res = await fetch(url, {
                    method,
                    headers: { 'Content-Type': 'application/json' },
                    body
                });

                if (res.ok) {
                    loadDocKeys();
                    document.getElementById('claveForm').reset();
                    document.getElementById('docKeyId').value = '';
                    showMessage('Clave guardada correctamente', 'success');
                } else {
                    const errorText = await res.text();
                    console.error('Error en la respuesta:', errorText);
                    showMessage('Error al guardar: ' + errorText, 'danger');
                }
            } catch (err) {
                console.error('Error en fetch:', err);
                showMessage('Error de red o servidor no disponible', 'danger');
            }
        }

    </script>

</body>
</html>
